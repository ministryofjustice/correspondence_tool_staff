<div align="center">

<a id="readme-top"></a>

<br>

<img alt="MoJ logo" src="https://moj-logos.s3.eu-west-2.amazonaws.com/moj-uk-logo.png" width="200">

# Correspondence Tools - Staff

[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=for-the-badge&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Fcorrespondence_tool_staff&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAABmJLR0QA/wD/AP+gvaeTAAAHJElEQVRYhe2YeYyW1RWHnzuMCzCIglBQlhSV2gICKlHiUhVBEAsxGqmVxCUUIV1i61YxadEoal1SWttUaKJNWrQUsRRc6tLGNlCXWGyoUkCJ4uCCSCOiwlTm6R/nfPjyMeDY8lfjSSZz3/fee87vnnPu75z3g8/kM2mfqMPVH6mf35t6G/ZgcJ/836Gdug4FjgO67UFn70+FDmjcw9xZaiegWX29lLLmE3QV4Glg8x7WbFfHlFIebS/ANj2oDgX+CXwA9AMubmPNvuqX1SnqKGAT0BFoVE9UL1RH7nSCUjYAL6rntBdg2Q3AgcAo4HDgXeBAoC+wrZQyWS3AWcDSUsomtSswEtgXaAGWlVI2q32BI0spj9XpPww4EVic88vaC7iq5Hz1BvVf6v3qe+rb6ji1p3pWrmtQG9VD1Jn5br+Knmm70T9MfUh9JaPQZu7uLsR9gEsJb3QF9gOagO7AuUTom1LpCcAkoCcwQj0VmJregzaipA4GphNe7w/MBearB7QLYCmlGdiWSm4CfplTHwBDgPHAFmB+Ah8N9AE6EGkxHLhaHU2kRhXc+cByYCqROs05NQq4oR7Lnm5xE9AL+GYC2gZ0Jmjk8VLKO+pE4HvAyYRnOwOH5N7NhMd/WKf3beApYBWwAdgHuCLn+tatbRtgJv1awhtd838LEeq30/A7wN+AwcBt+bwpD9AdOAkYVkpZXtVdSnlc7QI8BlwOXFmZ3oXkdxfidwmPrQXeA+4GuuT08QSdALxC3OYNhBe/TtzON4EziZBXD36o+q082BxgQuqvyYL6wtBY2TyEyJ2DgAXAzcC1+Xxw3RlGqiuJ6vE6QS9VGZ/7H02DDwAvELTyMDAxbfQBvggMAAYR9LR9J2cluH7AmnzuBowFFhLJ/wi7yiJgGXBLPq8A7idy9kPgvAQPcC9wERHSVcDtCfYj4E7gr8BRqWMjcXmeB+4tpbyG2kG9Sl2tPqF2Uick8B+7szyfvDhR3Z7vvq/2yqpynnqNeoY6v7LvevUU9QN1fZ3OTeppWZmeyzRoVu+rhbaHOledmoQ7LRd3SzBVeUo9Wf1DPs9X90/jX8m/e9Rn1Mnqi7nuXXW5+rK6oU7n64mjszovxyvVh9WeDcTVnl5KmQNcCMwvpbQA1xE8VZXhwDXAz4FWIkfnAlcBAwl6+SjD2wTcmPtagZnAEuA3dTp7qyNKKe8DW9UeBCeuBsbsWKVOUPvn+MRKCLeq16lXqLPVFvXb6r25dlaGdUx6cITaJ8fnpo5WI4Wuzcjcqn5Y8eI/1F+n3XvUA1N3v4ZamIEtpZRX1Y6Z/DUK2g84GrgHuDqTehpBCYend94jbnJ34DDgNGArQT9bict3Y3p1ZCnlSoLQb0sbgwjCXpY2blc7llLW1UAMI3o5CD4bmuOlwHaC6xakgZ4Z+ibgSxnOgcAI4uavI27jEII7909dL5VSrimlPKgeQ6TJCZVQjwaOLaW8BfyWbPEa1SaiTH1VfSENd85NDxHt1plA71LKRvX4BDaAKFlTgLeALtliDUqPrSV6SQCBlypgFlbmIIrCDcAl6nPAawmYhlLKFuB6IrkXAadUNj6TXlhDcCNEB/Jn4FcE0f4UWEl0NyWNvZxGTs89z6ZnatIIrCdqcCtRJmcCPwCeSN3N1Iu6T4VaFhm9n+riypouBnepLsk9p6p35fzwvDSX5eVQvaDOzjnqzTl+1KC53+XzLINHd65O6lD1DnWbepPBhQ3q2jQyW+2oDkkAtdt5udpb7W+Q/OFGA7ol1zxu1tc8zNHqXercfDfQIOZm9fR815Cpt5PnVqsr1F51wI9QnzU63xZ1o/rdPPmt6enV6sXqHPVqdXOCe1rtrg5W7zNI+m712Ir+cer4POiqfHeJSVe1Raemwnm7xD3mD1E/Z3wIjcsTdlZnqO8bFeNB9c30zgVG2euYa69QJ+9G90lG+99bfdIoo5PU4w362xHePxl1slMab6tV72KUxDvzlAMT8G0ZohXq39VX1bNzzxij9K1Qb9lhdGe931B/kR6/zCwY9YvuytCsMlj+gbr5SemhqkyuzE8xau4MP865JvWNuj0b1YuqDkgvH2GkURfakly01Cg7Cw0+qyXxkjojq9Lw+vT2AUY+DlF/otYq1Ixc35re2V7R8aTRg2KUv7+ou3x/14PsUBn3NG51S0XpG0Z9PcOPKWSS0SKNUo9Rv2Mmt/G5WpPF6pHGra7Jv410OVsdaz217AbkAPX3ubkm240belCuudT4Rp5p/DyC2lf9mfq1iq5eFe8/lu+K0YrVp0uret4nAkwlB6vzjI/1PxrlrTp/oNHbzTJI92T1qAT+BfW49MhMg6JUp7ehY5a6Tl2jjmVvitF9fxo5Yq8CaAfAkzLMnySt6uz/1k6bPx59CpCNxGfoSKA30IPoH7cQXdArwCOllFX/i53P5P9a/gNkKpsCMFRuFAAAAABJRU5ErkJggg==)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-report/correspondence_tool_staff)

</div>

An application to allow internal staff users to answer correspondence.

## Development

### Working on the Code

Work should be based off of, and PRed to, the main branch. We use the GitHub
PR approval process so once your PR is ready you'll need to have one person
approve it, and the CI tests passing, before it can be merged.


### Basic Setup

#### Cloning This Repository

Clone this repository then `cd` into the new directory

```
$ git clone git@github.com:ministryofjustice/correspondence_tool_staff.git
$ cd correspondence_tool_staff
```

### Installing the app for development

#### Out of the box - using docker compose

> [!TIP]
> To prevent issues with the local environment, we recommend using docker compose to run the app locally. This will ensure that the app runs in an environment similar to production.
> 
> To run the app using docker compose, you will need to have Docker installed on your machine. You can follow the instructions on the [Docker website](https://docs.docker.com/get-docker/) to install Docker.

Use the following command to start the app:

```
make
```
All software and dependencies will be installed automatically, and the app will be available at http://localhost:3000.

You can access PGAdmin4 at http://localhost:5050 with: 
- Username `cts@pgadmin.com` 
- Password `let-me-in`.

> [!IMPORTANT] 
> **Viewing DB data**
> 
> Additional setup is required to connect PGAdmin4 to the Postgres database running in the Docker container. 
> You will need to create a new server in PGAdmin4 with the following steps:
> 1. Click on "Tools" in the top menu and select "Import/Export Servers".
> 2. Select the "Import" tab.
> 3. Click on the directory button alongside the Filename field.
> 4. Click `server.json` in the file browser and click "Select".
> 5. Click "Next" to proceed.
> 6. Check the "Servers" checkbox and click "Next".
> 7. Click "Finish" to complete the import process.
> 8. When promoted, enter the password `postgres` to connect to the Postgres database.

### Manual setup - using rbenv and Homebrew

#### Latest Version of Ruby

If you don't have `rbenv` already installed, install it as follows:
```
$ brew install rbenv ruby-build
$ rbenv init
```

Follow the instructions printed out from the `rbenv init` command and update your `~/.bash_profile` or equivalent file accordingly, then start a new terminal and navigate to the repo directory.

Use `rbenv` to install the latest version of ruby as defined in `.ruby-version` (make sure you are in the repo path):

```
$ rbenv install
```

#### Dependencies

Node.js:

```
$ brew install node
```

Yarn

```
$ brew install yarn
```

Postgresql

```
$ brew install postgresql
```

Redis
```
$ brew install redis
```


#### Setup

Use the following commands to install gems and javascript packages then create the database

```
$ bin/setup
$ bin/yarn install
```

#### Seeds
Seeds can be loaded into the database via a rake task. The user accounts password is set with the `DEV_PASSWORD` env var.

```
$ DEV_PASSWORD=correspondence bin/rake db:seed:dev
```

#### Running locally:

To just run the web server without any background jobs (usually sufficient):

```
$ bin/rails server
```

If you need any of the background jobs running then start with:

```
$ bin/dev
```

The site will be accessible at http://localhost:3000.
You can login using one of the users created during the seeding process such as:
`correspondence-staff-dev+brian.rix@digital.justice.gov.uk` or `correspondence-staff-dev+david.attenborough@digital.justice.gov.uk` with the password set as `DEV_PASSWORD`

If you have any issues when running background jobs, start by checking that redis and postgresql are running with the below command:

```
$ brew services
```

### Testing

This project can produce code coverage data (w/o JS or views) using the `simplecov` gem
set COVERAGE=1 (or any value) to generate a coverage report.
Parallel tests are supposed to be supported - however the coverage output from simplecov is a little
strange (the total lines in the project are different for each coverage run)

This project includes the `parallel_tests` gem which enables multiple CPUs to be used during testing
in order to speed up execution. Otherwise running the tests takes an unacceptably long amount of time.

The default parallelism is 8 (override by setting PARALLEL_TEST_PROCESSORS) which seems to be about
right for a typical Macbook Pro (10,1 single processor with 4 cores)

#### To set up parallel testing

Create the required number of extra test databases:
```
rails parallel:create
```
Load the schema into all of the extra test databases:
```
rails parallel:load_structure
```
##### To run all the tests in parallel
```
rails parallel:spec
```
##### To run only feature tests in parallel
```
rails parallel:spec:features
```
##### To run only the non-feature tests in parallel
```
rails parallel:spec:non_features
```

#### Browser testing

We use chromedriver for Capybara tests, which require JavaScript. This is managed by selenium-webdriver.

If you have an existing old version on your PATH this may cause an issue so you will need to remove it from your PATH
or uninstall it.

Where we don't require JavaScript to test a feature we use Capybara's default driver
[RackTest](https://github.com/teamcapybara/capybara#racktest) which is ruby based
and much faster as it does not require a server to be started.

**Debugging:**

To debug a spec that requires JavaScript, you need to set a environment variable called CHROME_DEBUG.
It can be set to any value you like.

Examples:
```
$ CHROME_DEBUG=1 bin/rspec
```
When you have set `CHROME_DEBUG`, you should notice chrome start up and appear on your
taskbar. You can now click on chrome and watch it run through your tests.
If you have a `debugger`  in your tests the browser will stop at that point.


#### Emails

Emails are sent using
the [GOVUK Notify service](https://www.notifications.service.gov.uk). Email requests are sent asynchronously via Sidekiq.

Configuration relies on an API key which is not stored with the project, as even
the test API key can be used to access account information. To do local testing
you need to have an account that is attached to the "Track a query" service, and
a "Team and whitelist" API key generated from the GOVUK Notify service website.
See the instructions in the `.env.example` file for how to setup the correct
environment variable to override the `govuk_notify_api_key` setting.

The urls generated in the mail use the `cts_email_url` and `cts_email_port`
configuration variables from the `settings.yml`. These can be overridden by
setting the appropriate environment variables, e.g.

```
$ export SETTINGS__CTS_EMAIL_URL=localhost
$ export SETTINGS__CTS_EMAIL_PORT=5000
```

#### Devise OmniAuth - Azure Active Directory

In addition to sign in with email and password, there is an integration with
Azure Active Directory through Devise OmniAuth.

For this to work in your local machine, you will need to set 3 ENV variables.
See the instructions in the `.env.example` file.

A colleague can provide this to you. Usually, the tenant and client will be
the same for all local/dev environments, but the secret should be unique to
your machine, as this makes it easier to revoke it in case of a leak.

This feature can be enabled/disabled through the `enabled_features` mechanism
configured in [config/settings.yml](config/settings.yml).

#### Uploads

Responses and other case attachments are uploaded directly to S3 before being
submitted to the application to be added to the case. Each deployed environment
has the permissions is needs to access the uploads bucket for that environment.

In local development, uploads are made to the local filesystem.

#### Dumping the database

We have functionality to create an anonymised copy of the production or staging database. This feature is to be used as a very last resort. If the copy of the database is needed for debugging please consider the following options first:
- seeing if the issue is covered in the feature tests
- trying to track the issue through Kibana
- recreating the issue locally

If the options above do not solve the issue you by create an anonymised dump of the database by connecting to a pod and running:

```
rake db:dump:delete_s3_dumps[latest,false] && rake db:dump:local
```

This will upload the file to an S3 bucket by default which can be loaded to an environment by connecting and running:

```
rake db:dump:copy_s3_dumps && db:restore:local[,false,]
```

For more help with the data dump tasks run:

```
rake db:dump:help
```


### Papertrail

The papertrail gem is used as an auditing tool, keeping the old copies of records every time they are
changed.  There are a couple of complexities in using this tool which are described below:

#### JSONB fields on the database
The default serializer does not de-serialize the properties column correctly because internally it is
held as JSON, and papertrail serializes the object in YAML.  The custom serializer ```CTSPapertrailSerializer```
takes care of this and reconstitutes the JSON fields correctly.  See ```/spec/lib/papertrail_spec.rb``` for
examples of how to reify a previous version, or get a hash of field values for the previous version.

### Data Migrations

The app uses the `rails-data-migrations` gem https://github.com/anjlab/rails-data-migrations

Data migrations work like regular migrations but for data; they're found in `db/data_migrations`.

To create a data migration you need to run:

`rails generate data_migration migration_name`

and this will create a `migration_name.rb` file in `db/data_migrations` folder with the following content:

```
class MigrationName < DataMigration
  def up
    # put your code here
  end
end
```

Finally, at release time, you need to run:

`rake data:migrate`

This will run all pending data migrations and store migration history in data_migrations table.

### Letter templates and synchronising data

The app has templated correspondence for generating case-related letters for the Offender SAR case type.

The template body for each letter is maintained in the `letter_templates` table in the database, and populated from information in the /db/seeders/letter_template_seeder.rb script.

Whenever any changes to the letter templates are required DO NOT EDIT THE DATABASE, but amend the seeder and then on each environment, run `rails db:seed:dev:letter_templates` to delete and re-populate the table.

This is required whenever any new template is added; should someone have edited the versions in the database directly, those changes will be overwritten the next time the seeder is run.

### Site prism page manifest file

The tests use the Site Prism gem to manage page objects which behave as an abstract description of the pages in the application; they're used in feature tests for finding elements, describing the URL path for a given page and for defining useful methods e.g. for completing particular form fields on the page in question.

If you add new Site Prism page objects, it's easy to follow the existing structure - however, there is one gotcha which is that in order to refer to them in your tests, you also need to add the new objects to a manifest file here so that it maps an instantiated object to the new Page object class you've defined.

See `spec/site_prism/page_objects/pages/application.rb`

### Localisation keys checking

As part of the test suite, we check to see if any `tr` keys are missing from the localised YAML files

There is a command line tool provided to check for these manually as well - `i18n-tasks missing` - you can see the output from it below.

```
$ i18n-tasks missing
Missing translations (1) | i18n-tasks v0.9.29
+--------+------------------------------------+--------------------------------------------------+
| Locale | Key                                | Value in other locales or source                 |
+--------+------------------------------------+--------------------------------------------------+
|  all   | offender_sars.case_details.heading | app/views/offender_sars/case_details.html.slim:5 |
+--------+------------------------------------+--------------------------------------------------+

...fixing happens...

$ i18n-tasks missing
✓ Good job! No translations are missing.
$
```
There's also a similar task called `i18n-tasks unused`

```
$ i18n-tasks unused
Unused keys (1) | i18n-tasks v0.9.29
+--------+-----------------------+---------------+
| Locale | Key                   | Value         |
+--------+-----------------------+---------------+
|   en   | steps.new.sub_heading | Create a case |
+--------+-----------------------+---------------+
$ i18n-tasks unused
✓ Well done! Every translation is in use.
$
```

## Keeping secrets and sensitive information secure

There should be *absolutely no secure credentials* committed in this repo. Information about secret management can be found in the related confluence pages.

# Case Journey
1. **unassigned**
   A new case entered by a DACU user is created in this state.  It is in this state very
   briefly before it the user assigns it to a team on the next screen.

1. **awaiting_responder**
   The new case has been assigned to a business unit for response.

1. **drafting**
   A kilo in the responding business unit has accepted the case.

1. **pending_dacu_clearance**
   For cases that have an approver assignment with DACU Disclosure, as soon as a
   response file is uploaded, the case will transition to pending_dacu disclosure.
   The DACU disclosure team can either clear the case, in which case it goes forward to
   awaiting dispatch, or request changes, in which case it goes back to drafting.

1. **awaiting_dispatch**
   The Kilo has uploaded at least one response document.

1. **responded**
   The kilo has marked the response as sent.

1. **closed**
   The kilo has marked the case as closed.

## Exceptions
Any exceptions raised in any deployed environment will be sent to [Sentry](https://ministryofjustice.sentry.io/projects/track-a-query).

## Jobs

There are a variety of jobs that run, either using Sidekiq and triggered in code, or via a cronjob.

### Cronjobs

These are configured to run in Kubernetes. Not all jobs run in all environments.

| Name                                 | In Prod? | Details                                        | Frequency |
| ------------------------------------ | -------- | ---------------------------------------------- | --------- |
| email-status                         | Yes      | Checks and updates data request email status   | Hourly    |
| close-expired-rejected-offender-sars | Yes      | Closes expired rejected Offender SARs          | Daily     |
| send-chase-emails                    | Yes      | Sends Offender SAR data request chase emails   | Daily     |
| rpi-delete                           | Yes      | Deletes RPI files                              | Weekly    |
| db-anonymizer                        | No       | Dumps anonymised version of the database to S3 | N/A       |


### Sidekiq

When the server is running, you can view the sidekiq queues by going to http://localhost:3000/sidekiq.
This path can also be used on the live site when you are logged in as an admin.

| Name                          | Details                                 | Notes                                                              |
| ------------------            | --------------------------------------- | ------------------------------------------------------------------ |
| AnonymiserDbJob               | Anonymises database data for dumps      | Works with db-anonymizer cronjob                                   |
| EmailStatusJob                | Gets status of data request email       | Used by email-status cronjob and also when email is initially sent |
| PdfMakerJob                   | Creates PDF from case attachments       |                                                                    |
| PerformanceReportJob          | Used when creating some reports         |                                                                    |
| RequestPersonalInformationJob | Builds request from API and sends email |                                                                    |
| SearchIndexUpdaterJob         | Updates search index when case changes  |                                                                    |
| SearchIndexBuNameUpdaterJob   | Updater when Busines Unit name changes  | Calls the SearchIndexUpdaterJob for every case linked to the BU    |



## Troubleshooting: psql not found or permission issues

If you see an error like:

  Please check the output above for any errors and make sure that psql is installed in your PATH and has proper permissions

it means the PostgreSQL client tools are not available on your system PATH or they cannot be executed.

- Using Docker (recommended):
  - No action needed. Our dev image includes the PostgreSQL client tools and the entrypoint now performs a preflight check for `psql` and `pg_isready` before attempting to connect.
  - Start the stack with: `docker compose up`.

- Running locally without Docker:
  1) Install the PostgreSQL client tools (psql):
     - macOS (Homebrew): `brew install libpq && brew link --force libpq`
     - Ubuntu/Debian: `sudo apt-get update && sudo apt-get install -y postgresql-client`
     - Fedora: `sudo dnf install postgresql`
     - Windows: Install PostgreSQL from https://www.postgresql.org/download/ and ensure `psql.exe` is on your PATH.
  2) Verify installation: `psql --version` and `pg_isready --version`
  3) Ensure your environment variables are set, e.g.:
     - `export DATABASE_URL=postgresql://YOUR_USER@localhost/correspondence_platform_development`
     - Or copy `.env.example` to `.env` and adjust as needed.
  4) Test connectivity:
     - `psql "$DATABASE_URL" -c "SELECT 1;"`

- Permissions:
  - On Unix systems, ensure the binary is executable: `which psql` then `ls -l $(which psql)`.
  - If connecting to a local server via sockets, ensure you have permission to access the socket directory (commonly `/var/run/postgresql` or `/tmp`). Alternatively, use TCP by setting `PGHOST=127.0.0.1`.

