preamble:
  organisation: Ministry of Justice
  organisation_abbreviation: moj

  permitted_case_types:
    foi: Freedom of information request
    sar: Subject Access Request
    ico: Information Commissioner Office appeal
    overturned_sar: Overturned ICO appeal for SAR


case_types:
  foi:
    name: Freedom of Information Request
    permitted_workflows:
      - standard
      - trigger
      - full_approval

    permitted_user_roles:
      - manager
      - approver
      - responder

    permitted_states:
      - unassigned
      - awaiting_responder
      - drafting
      - pending_dacu_clearance
      - pending_press_office_clearance
      - pending_private_office_clearance
      - awaiting_dispatch
      - responded
      - closed


    workflows:
      standard:
        initial_state: unassigned
        user_roles:
          manager:
            states:
              unassigned:
                add_message_to_case:
                assign_responder:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?
                  switch_workflow: trigger

              awaiting_responder:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?
                  switch_workflow: trigger

              drafting:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?
                  switch_workflow: :trigger

              awaiting_dispatch:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?
                  switch_workflow: trigger

              responded:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                close:
                  transition_to: closed
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:
                update_closure:
                  if: Workflows::Predicates#can_edit_closure

          approver:
            states:
              unassigned:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                  switch_workflow: trigger
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                  switch_workflow: full_approval

              awaiting_responder:
                # accept approver assignment might seem an odd event to have in
                # the standard workflow, but it is here because an approver can
                # unaccept an trigger case, switching the workflow to standard,
                # and then decide to accept it again.
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                  switch_workflow: trigger
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                  switch_workflow: full_approval
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?

              drafting:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                  switch_workflow: trigger
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                  switch_workflow: full_approval
                unflag_for_clearance: # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                  switch_workflow: full_approval

              responded:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:

              closed:
                add_message_to_case:
                link_a_case:
                remove_linked_case:

          responder:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                accept_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: drafting
                reject_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: unassigned
                link_a_case:
                remove_linked_case:

              drafting:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                add_responses:
                  if: Case::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                  transition_to: awaiting_dispatch
                link_a_case:
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                remove_linked_case:

              awaiting_dispatch:
                 add_message_to_case:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   after_transition: Workflows::Hooks#notify_responder_message_received
                 add_responses:
                  if: Case::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                 link_a_case:
                 reassign_user:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                 remove_linked_case:
                 remove_response:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   transition_to_using: Workflows::Conditionals#remove_response_next_state
                 respond:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   transition_to: responded

              responded:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                link_a_case:
                remove_linked_case:

      trigger:
        initial_state: unassigned
        user_roles:
          manager:
            states:
              unassigned:
                add_message_to_case:
                assign_responder:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              awaiting_responder:
                add_message_to_case:
                assign_to_new_team:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              drafting:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              pending_dacu_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              awaiting_dispatch:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                flag_for_clearance:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?
                  switch_workflow: full_approval

              responded:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                close:
                  transition_to: closed
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:
                update_closure:
                  if: Workflows::Predicates#can_edit_closure

          approver:
            states:
              unassigned:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                flag_for_clearance:
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                  switch_workflow: full_approval
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow

              awaiting_responder:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                flag_for_clearance:
                link_a_case:
                reassign_user:
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                  switch_workflow: full_approval
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow

              drafting:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                flag_for_clearance:
                link_a_case:
                reassign_user:
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                  switch_workflow: full_approval
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow

              pending_dacu_clearance:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                approve:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: awaiting_dispatch
                  after_transition: Workflows::Hooks#notify_responder_ready_to_send
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                link_a_case:
                reassign_user:
                remove_linked_case:
                unaccept_approver_assignment:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  # if not flagged for press and private?
                  # do we want to transition straight away or is this the 'undo button' and so just needs to be given the another disclosure specialist
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow
                  transition_to_using: Workflows::Conditionals#unflag_for_clearance_next_state
                  after_transition: Workflows::Hooks#notify_responder_ready_to_send
                upload_response_and_approve:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: awaiting_dispatch
                  after_transition: Workflows::Hooks#notify_responder_ready_to_send
                upload_response_and_return_for_redraft:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  after_transition: Workflows::Hooks#notify_responder_redraft_requested
                  transition_to: drafting
                upload_response_approve_and_bypass:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: awaiting_dispatch

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                  switch_workflow: full_approval

              responded:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                link_a_case:
                remove_linked_case:


          responder:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                accept_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: drafting
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                remove_linked_case:
                reject_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: unassigned

              drafting:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                add_response_to_flagged_case:
                  if: Case::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                  transition_to: pending_dacu_clearance
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                upload_responses:

              pending_dacu_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                add_responses:
                  if: Case::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_last_response:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                remove_linked_case:
                remove_response:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to_using: Workflows::Conditionals#remove_response_next_state
                respond:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: responded
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance_by_press_or_private?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow

              responded:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                link_a_case:
                remove_linked_case:

      full_approval:
        initial_state: unassigned
        user_roles:
          manager:
            states:
              unassigned:
                add_message_to_case:
                assign_responder:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              awaiting_responder:
                add_message_to_case:
                assign_to_new_team:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              drafting:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              pending_dacu_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              pending_press_office_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?

              pending_private_office_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              awaiting_dispatch:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:
                request_further_clearance:
                  if: Case::FOI::StandardPolicy#can_request_further_clearance?
                  switch_workflow: trigger

              responded:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                close:
                  transition_to: closed
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:
                update_closure:
                  if: Workflows::Predicates#can_edit_closure

          approver:
            states:
              unassigned:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                flag_for_clearance:
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance_by_press_or_private?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow

              awaiting_responder:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                flag_for_clearance:
                link_a_case:
                reassign_user:
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance_by_press_or_private?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow

              drafting:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                flag_for_clearance:
                link_a_case:
                reassign_user:
                remove_linked_case:
                take_on_for_approval:
                  if: Case::BasePolicy#can_take_on_for_approval?
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance_by_press_or_private?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow

              pending_dacu_clearance:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                approve:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: pending_press_office_clearance
                approve_and_bypass:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: awaiting_dispatch
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                link_a_case:
                reassign_user:
                remove_linked_case:
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance_by_press_or_private?
                upload_response_and_approve:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: pending_press_office_clearance
                upload_response_approve_and_bypass:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: awaiting_dispatch
                upload_response_and_return_for_redraft:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  after_transition: Workflows::Hooks#notify_responder_redraft_requested
                  transition_to: drafting

              pending_press_office_clearance:
                # accept_approver_assignment:
                #   if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                approve:
                  if: Workflows::Predicates#user_is_assigned_press_officer?
                  transition_to: pending_private_office_clearance
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                request_amends:
                  if: Workflows::Predicates#user_is_assigned_press_officer?
                  transition_to: pending_dacu_clearance
                execute_request_amends:
                  if: Workflows::Predicates#user_is_assigned_press_officer?
                  transition_to: pending_dacu_clearance
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance_by_press_or_private?

              pending_private_office_clearance:
                # accept_approver_assignment:
                #   if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                approve:
                  if: Workflows::Predicates#user_is_assigned_private_officer?
                  transition_to: awaiting_dispatch
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                request_amends:
                  if: Workflows::Predicates#user_is_assigned_private_officer?
                  transition_to: pending_dacu_clearance
                execute_request_amends:
                  if: Workflows::Predicates#user_is_assigned_private_officer?
                  transition_to: pending_dacu_clearance
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance_by_press_or_private?

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                add_responses:
                  if: Case::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                flag_for_clearance:
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:
                remove_response:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to_using: Workflows::Conditionals#remove_response_next_state
                respond:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: responded
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:               # needed for press/private office to unaccept
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance_by_press_or_private?
                  switch_workflow_using: Workflows::Conditionals#unflag_for_clearance_next_workflow

              responded:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_in_approving_team_for_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                extend_for_pit:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:

              closed:
                add_message_to_case:
                link_a_case:
                remove_linked_case:

          responder:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                accept_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: drafting
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                remove_linked_case:
                reject_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: unassigned

              drafting:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                add_response_to_flagged_case:
                  if: Case::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                  transition_to: pending_dacu_clearance
                link_a_case:
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                remove_linked_case:
                upload_responses:

              pending_dacu_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:

              pending_press_office_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:

              pending_private_office_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:

              awaiting_dispatch:
                 add_message_to_case:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   after_transition: Workflows::Hooks#notify_responder_message_received
                 add_responses:
                  if: Case::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                 link_a_case:
                 reassign_user:
                   if: Case::BasePolicy#assignments_reassign_user?
                 remove_linked_case:
                 remove_response:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   transition_to_using: Workflows::Conditionals#remove_response_next_state
                 respond:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   transition_to: responded

              responded:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                link_a_case:
                remove_linked_case:

#########################################################################
#                                                                       #
#                               SAR                                     #
#                                                                       #
#########################################################################
  sar:
    name: Subject Access Request
    permitted_workflows:
      - standard
      - trigger

    permitted_user_roles:
      - manager
      - responder
      - approver

    permitted_states:
      - unassigned
      - awaiting_responder
      - drafting
      - pending_dacu_clearance
      - awaiting_dispatch
      - closed

    workflows:
      standard:
        initial_state: unassigned
        user_roles:

        ########################### SAR :: STANDARD WORKFLOW :: MANAGER ########################
          manager:
            states:
              unassigned:
                add_message_to_case:
                assign_responder:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:

              drafting:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                update_closure:
                link_a_case:
                remove_linked_case:

          ########################### SAR :: STANDARD WORKFLOW :: RESPONDER ########################
          responder:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              awaiting_responder:
                accept_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: drafting
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                reject_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: unassigned

              drafting:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                respond_and_close:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: closed
                respond:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                close:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: closed
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              closed:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                update_closure:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?


          ########################### SAR :: STANDARD WORKFLOW :: APPROVER ########################
          approver:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                flag_for_clearance:
                  switch_workflow: trigger

              awaiting_responder:
                flag_for_clearance:
                  switch_workflow: trigger

              drafting:
                flag_for_clearance:
                  switch_workflow: trigger



      ###########################TRIGGER SAR ########################
      trigger:
        initial_state: unassigned
        user_roles:

        ########################### SAR :: TRIGGER WORKFLOW :: MANAGER ########################
          manager:
            states:
              unassigned:
                add_message_to_case:
                assign_responder:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              drafting:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              pending_dacu_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              awaiting_dispatch:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                update_closure:
                link_a_case:
                remove_linked_case:

          ########################### SAR :: TRIGGER WORKFLOW :: RESPONDER ########################
          responder:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              awaiting_responder:
                accept_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: drafting
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                reject_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: unassigned

              drafting:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                progress_for_clearance:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: pending_dacu_clearance
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              pending_dacu_clearance:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                respond_and_close:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: closed
                respond:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                close:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: closed
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              closed:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                update_closure:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

          ########################### SAR :: STANDARD WORKFLOW :: APPROVER ########################
          approver:
            states:
              unassigned:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow: standard

              awaiting_responder:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow: standard

              drafting:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow: standard

              pending_dacu_clearance:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                approve:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  transition_to: awaiting_dispatch
                  after_transition: Workflows::Hooks#notify_responder_ready_to_send
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                request_amends:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_redraft_requested
                  transition_to: drafting
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow: standard
                  transition_to: drafting

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?

              closed:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?

  ico:
    name: Information Commissioner Office appeal
    permitted_workflows:
      - trigger

    permitted_user_roles:
      - manager
      - approver
      - responder

    permitted_states:
      - unassigned
      - awaiting_responder
      - drafting
      - pending_dacu_clearance
      - awaiting_dispatch
      - responded
      - closed
    workflows:

      trigger:
        initial_state: unassigned
        user_roles:
          manager:
            states:
              unassigned:
                add_message_to_case:
                assign_responder:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              drafting:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              pending_dacu_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              awaiting_dispatch:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              responded:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                close:
                  transition_to: closed
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              closed:
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:
                update_closure:
                  if: Workflows::Predicates#can_edit_closure

          approver:
            states:
              unassigned:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                link_a_case:
                reassign_user:
                remove_linked_case:
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?

              awaiting_responder:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                link_a_case:
                reassign_user:
                remove_linked_case:
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?

              drafting:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                link_a_case:
                reassign_user:
                remove_linked_case:
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?

              pending_dacu_clearance:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                approve:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: awaiting_dispatch
                  after_transition: Workflows::Hooks#notify_responder_ready_to_send
                link_a_case:
                reassign_user:
                remove_linked_case:
                unaccept_approver_assignment:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                upload_response_and_approve:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: awaiting_dispatch
                  after_transition: Workflows::Hooks#notify_responder_ready_to_send
                upload_response_and_return_for_redraft:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  after_transition: Workflows::Hooks#notify_responder_redraft_requested
                  transition_to: drafting
                upload_response_approve_and_bypass:
                  if: Workflows::Predicates#user_is_assigned_disclosure_specialist?
                  transition_to: awaiting_dispatch

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                link_a_case:
                reassign_user:
                remove_linked_case:

              responded:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                link_a_case:
                reassign_user:
                remove_linked_case:

              closed:
                link_a_case:
                remove_linked_case:

          responder:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                accept_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: drafting
                reject_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: unassigned
                link_a_case:
                remove_linked_case:

              drafting:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                add_response_to_flagged_case:
                  if: Case::ICO::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                  transition_to: pending_dacu_clearance
                link_a_case:
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                remove_linked_case:

              pending_dacu_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                link_a_case:
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                remove_linked_case:

              awaiting_dispatch:
                 add_message_to_case:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   after_transition: Workflows::Hooks#notify_responder_message_received
                 add_response_to_flagged_case:
                  if: Case::ICO::BasePolicy#can_add_attachment_to_flagged_and_unflagged_cases?
                 link_a_case:
                 reassign_user:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                 remove_linked_case:
                 remove_response:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   transition_to_using: Workflows::Conditionals#remove_response_next_state
                 respond:
                   if: Workflows::Predicates#responder_is_member_of_assigned_team?
                   transition_to: responded

              responded:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                link_a_case:
                remove_linked_case:

              closed:
                link_a_case:
                remove_linked_case:
  overturned_sar:
    name: Overturned ICO appeal for SAR
    permitted_workflows:
      - standard
      - trigger

    permitted_user_roles:
      - manager
      - responder
      - approver

    permitted_states:
      - unassigned
      - awaiting_responder
      - drafting
      - pending_dacu_clearance
      - awaiting_dispatch
      - closed
    workflows:
      standard:
        initial_state: unassigned
        user_roles:

        ########################### SAR :: STANDARD WORKFLOW :: MANAGER ########################
          manager:
            states:
              unassigned:
                add_message_to_case:
                assign_responder:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:

              drafting:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                flag_for_clearance:
                  switch_workflow: trigger
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                update_closure:
                link_a_case:
                remove_linked_case:

          ########################### SAR :: STANDARD WORKFLOW :: RESPONDER ########################
          responder:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              awaiting_responder:
                accept_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: drafting
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                reject_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: unassigned

              drafting:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                respond_and_close:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: closed
                respond:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                close:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: closed
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              closed:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                update_closure:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?


          ########################### SAR :: STANDARD WORKFLOW :: APPROVER ########################
          approver:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                flag_for_clearance:
                  switch_workflow: trigger

              awaiting_responder:
                flag_for_clearance:
                  switch_workflow: trigger

              drafting:
                flag_for_clearance:
                  switch_workflow: trigger



      ###########################TRIGGER SAR ########################
      trigger:
        initial_state: unassigned
        user_roles:

        ########################### SAR :: TRIGGER WORKFLOW :: MANAGER ########################
          manager:
            states:
              unassigned:
                add_message_to_case:
                assign_responder:
                  transition_to: awaiting_responder
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              awaiting_responder:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              drafting:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              pending_dacu_clearance:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              awaiting_dispatch:
                add_message_to_case:
                  after_transition: Workflows::Hooks#notify_responder_message_received
                assign_to_new_team:
                destroy_case:
                edit_case:
                link_a_case:
                remove_linked_case:

              closed:
                add_message_to_case:
                assign_to_new_team:
                destroy_case:
                edit_case:
                update_closure:
                link_a_case:
                remove_linked_case:

          ########################### SAR :: TRIGGER WORKFLOW :: RESPONDER ########################
          responder:
            states:
              unassigned:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              awaiting_responder:
                accept_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: drafting
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                reject_responder_assignment:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: unassigned

              drafting:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                progress_for_clearance:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: pending_dacu_clearance
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              pending_dacu_clearance:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                respond_and_close:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: closed
                respond:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                close:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                  transition_to: closed
                reassign_user:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

              closed:
                add_message_to_case:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?
                update_closure:
                  if: Workflows::Predicates#responder_is_member_of_assigned_team?

          ########################### SAR :: STANDARD WORKFLOW :: APPROVER ########################
          approver:
            states:
              unassigned:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow: standard

              awaiting_responder:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow: standard

              drafting:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow: standard

              pending_dacu_clearance:
                accept_approver_assignment:
                  if: Case::BasePolicy#can_accept_or_reject_approver_assignment?
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                approve:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  transition_to: awaiting_dispatch
                  after_transition: Workflows::Hooks#notify_responder_ready_to_send
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?
                request_amends:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_redraft_requested
                  transition_to: drafting
                unaccept_approver_assignment:
                  if: Case::BasePolicy#can_unaccept_approval_assignment?
                unflag_for_clearance:
                  if: Workflows::Predicates#case_can_be_unflagged_for_clearance?
                  switch_workflow: standard
                  transition_to: drafting

              awaiting_dispatch:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
                  after_transition: Workflows::Hooks#notify_responder_message_received
                reassign_user:
                  if: Case::BasePolicy#assignments_reassign_user?

              closed:
                add_message_to_case:
                  if: Workflows::Predicates#user_is_approver_on_case?
